# DC Motor Encoder Research (Not Finished)


## Overview
 A DC motor encoder is a device that is used to measure the speed and position of a direct current motor. It typically consists of a sensor that is attached to the motor shaft, which generates pulses as the shaft rotates. These pulses are converted into a digital signal that can be read by a control systems, allowing the motor's speed and position to be monitored and controlled. The data gathered by the encoder will be used in combination with an IMU for odometry the fundamental algorithm for computing robotic motion. 

 There are two main types of motor encoders
    
1. **Absolute encoders:** Gives a unique digital code for each distinct position of the motor shaft, allowing the exact position of the shaft to be determined at any time. Often used where precise position is required, especially in robot or machine tool applications
2. **Incremental Encoders:** An incremental encoder generates a series of pulses as the motor rotates, with the frequency of the pulses proportional to the speed of the shaft. This encoder does not provide absolute position measurement, but rather provides information about the change in position over time. Often used in applications where speed and relative position are more important than absolute position, such as conveyors or positioning stages.

Encoders can be analog or digital, and can use various technology to detect shaft rotation, including optical, magnetic, and capacitive sensors. 

This project does not need absolute positioning, thus we will be using incremental encoders. This will allow us to determine velocity, positioning, and orientation of the robot. We can also implement a PID Controller for optical control of the speed of the robot given the feedback of the encoder.

## Brief Introduction to PID Control Systems

![Encoder](https://www.thorlabs.com/images/TabImages/PID2.jpg)

The output of the PID control circuit, $u(t)$, is given as:

$u(t) = K_pe(t)+K_i\int_{0}^{t}e(t)dt + K_p\frac{de}{dt}$

Where $K_p$ = Proportional Gain, $K_i$ = Integral Gain, $K_d$ = Derivative Gain, $r(t)$ is the set point, $y(t)$ is the measured process variable, and $e(t) = r(t) - y(t)$. The $K$ constants can be tuned for a more stable controller to fix various issues such as rise time, overshoot, settling time, stability, and steady-state error. See the PID research document for more information (Not yet complete). 

In context of the RC car, our $y(t)$ would be the actual speed of our RC car measured by the encoder, while the set point would be our desired speed. Our $e(t)$ would be our error and the PID control will calculate a new PWM value to achieved the desired set point.

## Calculate direction and speed of DC motor using an Encoder

Using the signals generated by the Encoder, we can calculate the relative direction and speed of the DC motor. Inside the encoder is a slotted disc that is typically connected to ground. It also has two contact pins A and B. 

![Alt text](https://lastminuteengineers.b-cdn.net/wp-content/uploads/arduino/rotary-encoder-internal-structure.png)

As the motor spins, these contact pins generated a signal. When the knob is turned clockwise, the A pin connects to ground before the B pin. When the knob is turned anticlockwise, the B pin connects to the ground before the A pin. 

![Alt text](https://lastminuteengineers.b-cdn.net/wp-content/uploads/arduino/rotary-encoder-working-animation.gif)

When A changes state:
- If $B \neq A$, the shaft is turned clockwise 
  
  ![Alt text](/media/rotary-encoder-output-pulses-in-clockwise-rotation.png)
- If $B = A$, the shaft is turned counter clockwise
 
    ![Alt text](/media/rotary-encoder-output-pulses-in-anticlockwise-rotation.png)

Thus, we can use this information to determine the direction that the motor is spinning. The A pin can be used for state detection to detect change in position of the shaft, which can then fire a subroutine to calculate the orientation of the movement. 

An encoder typically has the following I/O:

<img src="./../../media/rotary.jpeg" width="400">

The Out A will be used for our state detection (via Interrupt) and Out B will be used for finding the direction. Output A/B will be connected as Digital Outputs to the Arduino. Note: The image shown is a dedicated rotary switch and is not connected to a DC motor. However, a DC motor with a built-in encoder will have the Out A/B built-in to the motor I/O.

In order to determine the speed, we need to calculate the RPM of our motor. This will then allow us to use the circumference of our wheel to calculate the speed our robot will travel. 

To calculate RPM, we use the following equation:

$RPM = \frac{revolutions}{minute} = \frac{(\text{Pulses Per Second} * 60)}{\text{Pulses Per Revolution}}$

Pulses per second is the number of pulses monitored within a one second period. We then convert it to pulses per minute by multiplying it by 60, since we are looking for revolutions per minute and not per second. We then divide this by the constant Pulses Per Revolution, which can be calculated by measuring the amount of pulses when manually rotating the encoder $360\degree$.